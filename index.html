<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowRider® Registration</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Signature Pad CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <style>
        /* ใช้ฟอนต์ Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* ซ่อน scrollbar ของ textarea ข้อตกลง */
        #agreement-text::-webkit-scrollbar {
            display: none;
        }
        #agreement-text {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* สไตล์สำหรับ Signature Pad */
        .signature-pad-container {
            border: 2px dashed #cbd5e1; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            position: relative;
            width: 100%;
            height: 200px;
            background-color: #f8fafc; /* gray-50 */
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        /* ปุ่มล้างลายเซ็น */
        #clear-signature {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.875rem;
            padding: 4px 8px;
        }
    </style>
    <!-- โหลดฟอนต์ Inter จาก Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">

        <!-- ===== Page 1: Language Selection ===== -->
        <div id="language-page" class="p-8 md:p-12 text-center">
            <!-- Logo Placeholder -->
            <img src="https://img2.pic.in.th/pic/logo-resize.webp" alt="Logo" class="mx-auto mb-8 w-48 md:w-64">
            
            <h2 id="lang-title" class="text-2xl md:text-3xl font-bold text-gray-800 mb-8">Please select a language.</h2>
            
            <div class="flex justify-center gap-6">
                <!-- TH Button -->
                <button onclick="goToAgreement('th')" class="flex flex-col items-center justify-center w-24 h-24 md:w-32 md:h-32 bg-blue-500 text-white rounded-full shadow-lg transition-transform transform hover:scale-105 hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    <svg class="w-8 h-8 md:w-10 md:h-10 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                    <span class="text-xl md:text-2xl font-bold">TH</span>
                </button>
                <!-- EN Button -->
                <button onclick="goToAgreement('en')" class="flex flex-col items-center justify-center w-24 h-24 md:w-32 md:h-32 bg-blue-500 text-white rounded-full shadow-lg transition-transform transform hover:scale-105 hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    <svg class="w-8 h-8 md:w-10 md:h-10 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                    <span class="text-xl md:text-2xl font-bold">EN</span>
                </button>
            </div>
        </div>

        <!-- ===== Page 2: Agreement ===== -->
        <div id="agreement-page" class="p-8 md:p-12 hidden">
            <h2 id="agreement-title" class="text-2xl font-bold text-gray-800 mb-4 text-center"></h2>
            
            <!-- Agreement Text Box -->
            <div id="agreement-text" class="h-64 md:h-80 overflow-y-auto border border-gray-300 rounded-lg p-4 bg-gray-50 text-gray-700 text-sm mb-6">
                <!-- Content will be inserted by JavaScript -->
            </div>
            
            <!-- Agreement Checkbox -->
            <div class="flex items-center mb-6">
                <input id="agreement-checkbox" type="checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label id="agreement-label" for="agreement-checkbox" class="ml-3 block text-sm md:text-base font-medium text-gray-700"></label>
            </div>
            
            <!-- Navigation Buttons -->
            <div class="flex justify-between">
                <button id="agreement-back" onclick="goToLanguage()" class="py-2 px-6 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition duration-300"></button>
                <button id="agreement-next" onclick="goToForm()" class="py-2 px-6 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled></button>
            </div>
        </div>

        <!-- ===== Page 3: Registration Form ===== -->
        <div id="form-page" class="p-8 md:p-12 hidden">
            <h2 id="form-title" class="text-2xl font-bold text-gray-800 mb-6 text-center"></h2>
            
            <form id="registration-form" novalidate>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <!-- First Name -->
                    <div>
                        <label id="label-firstName" for="firstName" class="block text-sm font-medium text-gray-700"></label>
                        <input type="text" id="firstName" name="firstName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <!-- Last Name -->
                    <div>
                        <label id="label-lastName" for="lastName" class="block text-sm font-medium text-gray-700"></label>
                        <input type="text" id="lastName" name="lastName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <!-- Date of Birth -->
                    <div>
                        <label id="label-dob" for="dob" class="block text-sm font-medium text-gray-700"></label>
                        <input type="date" id="dob" name="dob" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <!-- Age -->
                    <div>
                        <label id="label-age" for="age" class="block text-sm font-medium text-gray-700"></label>
                        <input type="text" id="age" name="age" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 focus:outline-none">
                    </div>
                    <!-- Emergency Contact Name -->
                    <div class="md:col-span-2">
                        <label id="label-emergencyName" for="emergencyName" class="block text-sm font-medium text-gray-700"></label>
                        <input type="text" id="emergencyName" name="emergencyName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <!-- Emergency Contact Phone -->
                    <div class="md:col-span-2">
                        <label id="label-emergencyPhone" for="emergencyPhone" class="block text-sm font-medium text-gray-700"></label>
                        <input type="tel" id="emergencyPhone" name="emergencyPhone" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <!-- Signature Pad -->
                    <div class="md:col-span-2">
                        <label id="label-signature" class="block text-sm font-medium text-gray-700 mb-1"></label>
                        <div class="signature-pad-container">
                            <canvas id="signature-canvas"></canvas>
                            <button type="button" id="clear-signature" class="bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300"></button>
                        </div>
                        <input type="hidden" id="signature-data" name="signature">
                    </div>
                </div>
                
                <!-- Form Buttons -->
                <div class="flex justify-between mt-8">
                    <button id="form-back" type="button" onclick="showPage('agreement-page')" class="py-2 px-6 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition duration-300"></button>
                    <button id="form-submit" type="submit" class="py-2 px-6 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-300"></button>
                </div>
            </form>
        </div>

        <!-- ===== Page 4: Success Message ===== -->
        <div id="success-page" class="p-8 md:p-12 text-center hidden">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h2 id="success-title" class="text-2xl font-bold text-gray-800 mb-4"></h2>
            <p id="success-message" class="text-gray-600 mb-8"></p>
            <button id="success-button" onclick="resetApp()" class="py-2 px-6 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-300"></button>
        </div>

        <!-- ===== Page 5: Error Message ===== -->
        <div id="error-page" class="p-8 md:p-12 text-center hidden">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <h2 id="error-title" class="text-2xl font-bold text-gray-800 mb-4"></h2>
            <p id="error-message" class="text-gray-600 mb-8"></p>
            <button id="error-button" onclick="showPage('form-page')" class="py-2 px-6 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-300"></button>
        </div>
    </div>

    <!-- ===== Loading Overlay ===== -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="w-16 h-16 border-4 border-t-blue-500 border-gray-200 rounded-full animate-spin"></div>
    </div>

    <!-- ===== JavaScript ===== -->
    <script>
        // --- Globals ---
        let selectedLang = 'en';
        let signaturePad;
        const appScriptUrl = 'https://script.google.com/macros/s/AKfycbyrreHAORaQtEx36gZqSJ-h6OuUojYYyJlIILi6aHKcJMNEP3fkYXAzo8ZjOQ6UEp-xfA/exec';

        // --- Translations Object ---
        const translations = {
            en: {
                langTitle: "Please select a language.",
                agreementTitle: "FlowRider® Voluntary Acknowledgement of Risks",
                agreementText: `
                    <p class="font-bold mb-2">RIDING ON THE FLOWRIDER® IS AN EXTREME SPORT AND HIGH RISK RECREATIONAL ACTIVITY. SHEET WAVE SURFING ON OR IN PROXIMITY TO THE FLOWRIDER® MAY RESULT IN PHYSICAL OR MENTAL INJURY, ILLNESS OR DISEASE, OR DEATH.</p>
                    <p class="mb-2">This document affects your legal rights. By writing your signature below, you acknowledge that you have read and understood the disclosures of risks, voluntarily accept those risks, and agree to be bound by all terms of this Release of Liability and Indemnity Agreement.</p>
                    <p class="mb-2">My signature acknowledges that I or the minor for whom I am a legal guardian (collectively referred to as “I”, “me”, or “my”) have voluntarily chosen to participate in the sheet wave surfing attraction known as the FlowRider® or use a Flowboard™ (collectively referred to as the “Activities”) and to use the facilities at Vana Nava Water Jungle including but not limited to the FlowRider® (collectively referred to as the “Facilities”).</p>
                    <p>...</p>
                    <p class="font-bold mt-4">VOLUNTARY ACCEPTANCE AND ASSUMPTION OF RISK AND RESPONSIBILITY. I EXPRESSLY AND VOLUNTARILY AGREE, COVENANT AND PROMISE TO ACCEPT AND ASSUME ALL RESPONSIBILITIES, AND RISK FOR INJURY, DEATH, ILLNESS OR DISEASE, OR DAMAGE to me or to my property, arising from my participation in the Activities.</p>
                    <p class="italic mt-2">(This is sample text based on the image. Please replace with your full agreement text.)</p>
                `,
                agreementLabel: "I have read and agree to the terms and conditions.",
                backButton: "Back",
                nextButton: "Next",
                formTitle: "Registration Form",
                labelFirstName: "First Name",
                labelLastName: "Last Name",
                labelDob: "Date of Birth",
                labelAge: "Age",
                labelEmergencyName: "Emergency Contact Name",
                labelEmergencyPhone: "Emergency Contact Telephone",
                labelSignature: "Signature (Please sign below)",
                clearButton: "Clear",
                submitButton: "Submit",
                successTitle: "Registration Successful!",
                successMessage: "Your information has been submitted.",
                successButton: "Register Another",
                errorTitle: "Submission Failed",
                errorMessage: "An error occurred. Please try again.",
                errorButton: "Try Again",
                validationSignature: "Signature is required.",
                validationGeneric: "Please fill out all required fields."
            },
            th: {
                langTitle: "กรุณาเลือกภาษา",
                agreementTitle: "ข้อตกลงว่าด้วยการปลดเปลื้องความรับผิด",
                agreementText: `
                    <p class="font-bold mb-2">โฟลว์ไรเดอร์เป็นเครื่องเล่นกีฬาทางน้ำ โต้คลื่น และมีความเสี่ยงสูง ซึ่งอาจส่งผลให้เกิดการบาดเจ็บทางร่างกายหรือจิตใจ หรืออาจถึงแก่ชีวิตได้</p>
                    <p class="mb-2">เอกสารนี้มีผลต่อสิทธิ์ทางกฎหมายของท่าน การลงลายมือชื่อด้านล่างแสดงว่าท่านรับทราบว่าได้อ่านและทำความเข้าใจการเปิดเผยข้อมูลความเสี่ยง ยอมรับความเสี่ยงเหล่านั้นโดยสมัครใจ และตกลงที่จะผูกพันตามข้อกำหนดทั้งหมดของข้อตกลงการปลดเปลื้องความรับผิดและการชดใช้ค่าเสียหายนี้</p>
                    <p class="mb-2">ลายมือชื่อของข้าพเจ้าเป็นการรับทราบว่าข้าพเจ้าหรือผู้เยาว์ที่ข้าพเจ้าเป็นผู้ปกครองโดยชอบด้วยกฎหมาย (ต่อไปนี้เรียกรวมกันว่า "ข้าพเจ้า") ได้เลือกเข้าร่วมกิจกรรมโต้คลื่นบนแผ่นกระดานโต้คลื่นที่เรียกว่า โฟลว์ไรเดอร์ หรือใช้ โฟลว์บอร์ด (ต่อไปนี้เรียกรวมกันว่า "กิจกรรม") และเพื่อใช้สิ่งอำนวยความสะดวกที่ วานา นาวา วอเตอร์ จังเกิ้ล ซึ่งรวมถึงแต่ไม่จำกัดเพียง โฟลว์ไรเดอร์ (ต่อไปนี้เรียกรวมกันว่า "สิ่งอำนวยความสะดวก")</p>
                    <p>...</p>
                    <p class="font-bold mt-4">การยอมรับความเสี่ยงและความรับผิดชอบโดยสมัครใจ ข้าพเจ้าตกลง ยอมรับ และสัญญาโดยชัดแจ้งและโดยสมัครใจที่จะยอมรับและรับผิดชอบทั้งหมดต่อความรับผิดชอบและความเสี่ยงต่อการบาดเจ็บ การเสียชีวิต การเจ็บป่วย หรือโรค หรือความเสียหายต่อข้าพเจ้าหรือต่อทรัพย์สินของข้าพเจ้า อันเกิดจากการเข้าร่วมกิจกรรมของข้าพเจ้า</p>
                    <p class="italic mt-2">(นี่คือเนื้อหาตัวอย่างจากภาพ กรุณาแทนที่ด้วยข้อตกลงฉบับเต็ม)</p>
                `,
                agreementLabel: "ข้าพเจ้าได้อ่านและยอมรับข้อตกลงและเงื่อนไข",
                backButton: "ย้อนกลับ",
                nextButton: "ถัดไป",
                formTitle: "แบบฟอร์มลงทะเบียน",
                labelFirstName: "ชื่อ",
                labelLastName: "นามสกุล",
                labelDob: "วันเกิด",
                labelAge: "อายุ",
                labelEmergencyName: "ชื่อผู้ติดต่อกรณีฉุกเฉิน",
                labelEmergencyPhone: "หมายเลขติดต่อกรณีฉุกเฉิน",
                labelSignature: "ลายเซ็น (กรุณาลงนามด้านล่าง)",
                clearButton: "ล้าง",
                submitButton: "ส่งข้อมูล",
                successTitle: "ลงทะเบียนสำเร็จ!",
                successMessage: "ข้อมูลของคุณถูกส่งเรียบร้อยแล้ว",
                successButton: "ลงทะเบียนอีกครั้ง",
                errorTitle: "ส่งข้อมูลไม่สำเร็จ",
                errorMessage: "เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง",
                errorButton: "ลองอีกครั้ง",
                validationSignature: "กรุณาลงลายเซ็น",
                validationGeneric: "กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน"
            }
        };

        // --- Page Navigation ---
        function showPage(pageId) {
            document.getElementById('language-page').classList.add('hidden');
            document.getElementById('agreement-page').classList.add('hidden');
            document.getElementById('form-page').classList.add('hidden');
            document.getElementById('success-page').classList.add('hidden');
            document.getElementById('error-page').classList.add('hidden');
            document.getElementById(pageId).classList.remove('hidden');
        }

        function showLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }

        // --- Language Functions ---
        function setLanguage(lang) {
            selectedLang = lang;
            const t = translations[lang];

            // Set body font based on language
            if (lang === 'th') {
                document.body.style.fontFamily = "'Sarabun', sans-serif";
            } else {
                document.body.style.fontFamily = "'Inter', sans-serif";
            }

            // Language Page
            document.getElementById('lang-title').textContent = t.langTitle;

            // Agreement Page
            document.getElementById('agreement-title').textContent = t.agreementTitle;
            document.getElementById('agreement-text').innerHTML = t.agreementText;
            document.getElementById('agreement-label').textContent = t.agreementLabel;
            document.getElementById('agreement-back').textContent = t.backButton;
            document.getElementById('agreement-next').textContent = t.nextButton;

            // Form Page
            document.getElementById('form-title').textContent = t.formTitle;
            document.getElementById('label-firstName').textContent = t.labelFirstName;
            document.getElementById('label-lastName').textContent = t.labelLastName;
            document.getElementById('label-dob').textContent = t.labelDob;
            document.getElementById('label-age').textContent = t.labelAge;
            document.getElementById('label-emergencyName').textContent = t.labelEmergencyName;
            document.getElementById('label-emergencyPhone').textContent = t.labelEmergencyPhone;
            document.getElementById('label-signature').textContent = t.labelSignature;
            document.getElementById('clear-signature').textContent = t.clearButton;
            document.getElementById('form-back').textContent = t.backButton;
            document.getElementById('form-submit').textContent = t.submitButton;

            // Success Page
            document.getElementById('success-title').textContent = t.successTitle;
            document.getElementById('success-message').textContent = t.successMessage;
            document.getElementById('success-button').textContent = t.successButton;

            // Error Page
            document.getElementById('error-title').textContent = t.errorTitle;
            document.getElementById('error-message').textContent = t.errorMessage;
            document.getElementById('error-button').textContent = t.errorButton;
        }

        function goToLanguage() {
            showPage('language-page');
        }

        function goToAgreement(lang) {
            setLanguage(lang);
            showPage('agreement-page');
        }

        function goToForm() {
            showPage('form-page');
            // Initialize signature pad only when the page is shown
            if (!signaturePad) {
                initSignaturePad();
            }
            resizeCanvas();
        }

        // --- Form Functions ---
        function calculateAge() {
            const dobInput = document.getElementById('dob').value;
            if (dobInput) {
                const dob = new Date(dobInput);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                document.getElementById('age').value = age;
            }
        }

        function generateUUID() {
            // A simple UUID generator
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        function getFormattedDateTime(date) {
            const optionsDate = { year: 'numeric', month: '2-digit', day: '2-digit' };
            // ใช้ th-TH locale แต่ปรับ format ให้เป็นสากล (yyyy-mm-dd) เพื่อให้ Google Sheet จัดการง่าย
            // หรือจะใช้ 'th-TH' locale แบบเต็มก็ได้
            // const formattedDate = date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            // ใช้ format ที่ Google Sheet น่าจะเข้าใจง่าย
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            const formattedDate = `${dd}/${mm}/${yyyy}`; // Format DD/MM/YYYY
            
            const formattedTime = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            return { date: formattedDate, time: formattedTime };
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const t = translations[selectedLang];

            // Client-side validation
            if (!form.checkValidity()) {
                form.reportValidity();
                alert(t.validationGeneric);
                return;
            }

            if (signaturePad.isEmpty()) {
                alert(t.validationSignature);
                return;
            }

            showLoading(true);

            // Get form data
            const formData = new FormData(form);
            const signatureData = signaturePad.toDataURL(); // Base64 PNG
            const now = new Date();
            const { date, time } = getFormattedDateTime(now);

            // --- เตรียมข้อมูลส่ง Google Sheet ---
            // ชื่อคอลัมน์ต้องตรงกับใน Google Sheet
            const dataToSubmit = new FormData();
            dataToSubmit.append('ID', generateUUID());
            dataToSubmit.append('ชื่อ', formData.get('firstName'));
            dataToSubmit.append('นามสกุล', formData.get('lastName'));
            dataToSubmit.append('วันเกิด', formData.get('dob')); // ส่งเป็น YYYY-MM-DD
            dataToSubmit.append('อายุ', formData.get('age'));
            dataToSubmit.append('ชื่อผู้ติดต่อกรณีฉุกเฉิน', formData.get('emergencyName'));
            dataToSubmit.append('หมายเลขติดต่อกรณีฉุกเฉิน', formData.get('emergencyPhone'));
            dataToSubmit.append('เวลา', time);
            dataToSubmit.append('ลายเซ็น', signatureData); // ส่งเป็น Base64 Data URL
            dataToSubmit.append('วันที่', date);


            // --- ส่งข้อมูลไปยัง Google Apps Script ---
            try {
                const response = await fetch(appScriptUrl, {
                    method: 'POST',
                    body: dataToSubmit,
                    // mode: 'no-cors' // อาจจำเป็นถ้า Apps Script ไม่ได้ตั้งค่า CORS
                });
                
                // Google Apps Script ที่ redirect มักจะคืนค่า response.type = 'opaque'
                // เราจะถือว่าถ้า fetch ไม่ throw error คือสำเร็จ
                
                // const result = await response.json(); // อาจจะไม่ทำงานถ้ามี redirect
                // console.log('Success:', result);

                showLoading(false);
                showPage('success-page');
                resetForm();

            } catch (error) {
                console.error('Error submitting form:', error);
                showLoading(false);
                showPage('error-page');
            }
        }
        
        function resetForm() {
            document.getElementById('registration-form').reset();
            signaturePad.clear();
            document.getElementById('age').value = '';
            document.getElementById('agreement-checkbox').checked = false;
            document.getElementById('agreement-next').disabled = true;
        }
        
        function resetApp() {
            resetForm();
            showPage('language-page');
        }

        // --- Signature Pad Functions ---
        function initSignaturePad() {
            const canvas = document.getElementById('signature-canvas');
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(248, 250, 252)', // bg-gray-50
                penColor: 'rgb(0, 0, 0)'
            });
            document.getElementById('clear-signature').addEventListener('click', () => {
                signaturePad.clear();
            });
        }

        function resizeCanvas() {
            if (signaturePad) {
                const canvas = document.getElementById('signature-canvas');
                const ratio =  Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                signaturePad.clear(); // เคลียร์ canvas หลัง resize
            }
        }

        // --- Event Listeners ---
        window.addEventListener('resize', resizeCanvas);
        
        document.getElementById('agreement-checkbox').addEventListener('change', (e) => {
            document.getElementById('agreement-next').disabled = !e.target.checked;
        });

        document.getElementById('dob').addEventListener('change', calculateAge);

        document.getElementById('registration-form').addEventListener('submit', handleFormSubmit);

        // --- Initial Setup ---
        // เริ่มต้นด้วยภาษาอังกฤษ
        setLanguage('en'); 
        showPage('language-page');

    </script>
</body>
</html>
