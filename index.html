<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vana Nava - FlowRider Registration</title>
    <!-- 1. โหลด Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. โหลด SignaturePad.js สำหรับลายเซ็น -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <style>
        /* CSS เพิ่มเติมเล็กน้อยสำหรับ Signature Pad */
        .signature-canvas {
            border: 2px dashed #cbd5e1; /* tailwind's gray-300 */
            border-radius: 0.5rem; /* tailwind's rounded-lg */
            cursor: crosshair;
        }
        /* ซ่อนหน้าต่างๆ ไว้ก่อน */
        .page {
            display: none;
        }
        /* คลาสสำหรับแสดงหน้าปัจจุบัน */
        .page.active {
            display: block;
        }
        /*  */
        .logo-container {
            background-image: url('https://placehold.co/800x300/f0f9ff/0ea5e9?text=Vana+Nava+Water+Jungle');
            background-size: cover;
            background-position: center;
            height: 200px;
            position: relative;
        }
        .logo-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            padding: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen font-sans">

    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden m-4">

        <!-- ===== 1. หน้าเลือกภาษา (Language Selection Page) ===== -->
        <div id="lang-page" class="page active p-6 md:p-10 text-center">
            <div class="logo-container -m-6 md:-m-10 mb-6 rounded-t-lg">
                <div class="logo-overlay">
                    <h1 class="text-2xl md:text-3xl font-bold text-white">Please select a language.</h1>
                </div>
            </div>
            
            <p class="text-gray-600 mb-8 mt-8">กรุณาเลือกภาษา / Please select a language</p>
            <div class="flex justify-center gap-4">
                <!-- ปุ่มเลือกภาษาไทย -->
                <button onclick="selectLang('th')" class="flex flex-col items-center justify-center w-24 h-24 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-all transform hover:scale-105">
                    <svg class="w-10 h-10 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                    <span class="font-semibold">TH</span>
                </button>
                <!-- ปุ่มเลือกภาษาอังกฤษ -->
                <button onclick="selectLang('en')" class="flex flex-col items-center justify-center w-24 h-24 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-all transform hover:scale-105">
                    <svg class="w-10 h-10 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                    <span class="font-semibold">EN</span>
                </button>
            </div>
        </div>

        <!-- ===== 2. หน้าข้อตกลง (Agreement Page) ===== -->
        <div id="agreement-page" class="page p-6 md:p-10">
            <h2 class="text-2xl font-bold mb-4" data-lang-key="agreement_title">ข้อตกลงและเงื่อนไข</h2>
            
            <!-- กล่องข้อความข้อตกลง -->
            <div class="h-64 overflow-y-auto border border-gray-300 rounded-lg p-4 bg-gray-50 text-sm text-gray-700">
                <!-- ข้อความภาษาไทย -->
                <div data-lang-key="agreement_text_th" class="lang-text">
                    <h3 class="font-bold text-lg mb-2">ข้อตกลงว่าด้วยการปลอดเปลื้องความรับผิด</h3>
                    <p>โฟลว์ไรเดอร์เป็นเครื่องเล่นกีฬาทางน้ำ โต้คลื่น และมีความเสี่ยงสูง คลื่นอาจซัดลงมาที่เครื่องโฟลว์ไรเดอร์ หรืออาจร่างกายบาดเจ็บทางร่างกาย และจิตใจ หรือเจ็บป่วย โรคภัย หรืออาจทำให้ถึงแก่ชีวิตได้ เอกสารนี้เกี่ยวข้องกับสิทธิตามกฎหมายของท่าน การลงลายมือชื่อถือเป็นเอกสารยืนยันการเป็นเครื่องเล่นและท่านได้อ่านและทำความเข้าใจถึงปัจจัยต่างๆที่อาจเกิดขึ้นจากการใช้เครื่องเล่นดังกล่าวแล้ว และยินยอมรับในความเสี่ยงเหล่านั้นโดยสมัครใจ และตกลงที่จะผูกพันตนตามข้อกำหนดว่าด้วยการปลอดเปลื้องความรับผิดและการชดใช้ค่าเสียหายฉบับนี้...</p>
                    <p class="mt-2">[...เนื้อหาข้อตกลงส่วนที่เหลือ...]</p>
                </div>
                <!-- ข้อความภาษาอังกฤษ -->
                <div data-lang-key="agreement_text_en" class="lang-text" style="display: none;">
                    <h3 class="font-bold text-lg mb-2">FlowRider® Voluntary Acknowledgement of Risks</h3>
                    <p>RIDING ON THE FLOWRIDER® IS AN EXTREME SPORT AND HIGH RISK RECREATIONAL ACTIVITY. SHEET WAVE SURFING ON OR IN PROXIMITY TO THE FLOWRIDER® MAY RESULT IN PHYSICAL OR MENTAL INJURY, ILLNESS OR DISEASE, OR DEATH. This document affects your legal rights. By writing your signature below, you acknowledge that you have read and understood the disclosures of risks, voluntarily accept those risks, and agree to be bound by all terms of this Release of Liability and Indemnity Agreement...</p>
                    <p class="mt-2">[...Rest of the agreement text...]</p>
                </div>
            </div>

            <!-- Checkbox ยอมรับ -->
            <div class="mt-6">
                <label class="flex items-center">
                    <input type="checkbox" id="agree-checkbox" class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                    <span class="ml-3 text-gray-700" data-lang-key="agreement_check">ข้าพเจ้ายอมรับข้อตกลงและเงื่อนไข</span>
                </label>
            </div>

            <!-- ปุ่มดำเนินการต่อ -->
            <div class="flex justify-end mt-6">
                <button id="continue-btn" onclick="showPage('form-page')" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-all opacity-50 cursor-not-allowed" disabled>
                    <span data-lang-key="continue_button">ดำเนินการต่อ</span> &rarr;
                </button>
            </div>
        </div>

        <!-- ===== 3. หน้าฟอร์มลงทะเบียน (Registration Form Page) ===== -->
        <div id="form-page" class="page p-6 md:p-10">
            <h2 class="text-2xl font-bold mb-6" data-lang-key="form_title">แบบฟอร์มลงทะเบียน</h2>
            
            <form id="registration-form" class="space-y-4">
                <!-- ชื่อ - นามสกุล -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="first-name" class="block text-sm font-medium text-gray-700" data-lang-key="form_fname">ชื่อ</label>
                        <input type="text" id="first-name" name="firstName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="last-name" class="block text-sm font-medium text-gray-700" data-lang-key="form_lname">นามสกุล</label>
                        <input type="text" id="last-name" name="lastName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                </div>

                <!-- วันเกิด -->
                <div>
                    <label for="dob" class="block text-sm font-medium text-gray-700" data-lang-key="form_dob">วันเกิด (ค.ศ.)</A></label>
                    <input type="date" id="dob" name="dob" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>

                <!-- ข้อมูลติดต่อฉุกเฉิน -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="emergency-name" class="block text-sm font-medium text-gray-700" data-lang-key="form_emergency_name">ชื่อผู้ติดต่อฉุกเฉิน</label>
                        <input type="text" id="emergency-name" name="emergencyName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="emergency-phone" class="block text-sm font-medium text-gray-700" data-lang-key="form_emergency_phone">เบอร์โทรผู้ติดต่อฉุกเฉิน</label>
                        <input type="tel" id="emergency-phone" name="emergencyPhone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                </div>

                <!-- ลายเซ็น -->
                <div>
                    <label class="block text-sm font-medium text-gray-700" data-lang-key="form_signature">ลายเซ็น</label>
                    <div class="mt-1 relative">
                        <canvas id="signature-canvas" class="signature-canvas w-full h-40 bg-white"></canvas>
                        <button type="button" id="clear-signature" class="absolute top-2 right-2 bg-gray-200 text-gray-700 text-xs py-1 px-2 rounded hover:bg-gray-300" data-lang-key="form_clear_sig">ล้าง</button>
                    </div>
                    <input type="hidden" id="signature-data" name="signatureData">
                </div>

                <!-- ปุ่ม Submit -->
                <div class="flex justify-end pt-4">
                    <button type="submit" id="submit-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-green-700 transition-all flex items-center">
                        <!-- Loading Spinner (ซ่อนไว้ก่อน) -->
                        <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style="display: none;">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span data-lang-key="form_submit">บันทึกข้อมูล</span>
                    </button>
                </div>
            </form>

            <!-- ข้อความแจ้งเตือน -->
            <div id="success-message" class="hidden mt-4 p-4 rounded-md bg-green-100 text-green-700">
                <span data-lang-key="msg_success">บันทึกข้อมูลสำเร็จ!</span>
            </div>
            <div id="error-message" class="hidden mt-4 p-4 rounded-md bg-red-100 text-red-700">
                <span data-lang-key="msg_error">เกิดข้อผิดพลาด:</span> <span id="error-text"></span>
            </div>
        </div>
    </div>

    <script>
        // ===== URL ของ Google Apps Script (สำคัญมาก!) =====
        // ให้คุณนำ URL ที่ได้จากการ Deploy Google Apps Script มาวางที่นี่
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyrreHAORaQtEx36gZqSJ-h6OuUojYYyJlIILi6aHKcJMNEP3fkYXAzo8ZjOQ6UEp-xfA/exec'; 
        
        // ===================================================

        let currentLang = 'th'; // ภาษาเริ่มต้น
        let signaturePad; // ตัวแปรสำหรับเก็บ SignaturePad

        // ข้อความสำหรับเปลี่ยนภาษา
        const translations = {
            th: {
                agreement_title: "ข้อตกลงและเงื่อนไข",
                agreement_check: "ข้าพเจ้ายอมรับข้อตกลงและเงื่อนไข",
                continue_button: "ดำเนินการต่อ",
                form_title: "แบบฟอร์มลงทะเบียน",
                form_fname: "ชื่อ",
                form_lname: "นามสกุล",
                form_dob: "วันเกิด (ค.ศ.)",
                form_emergency_name: "ชื่อผู้ติดต่อฉุกเฉิน",
                form_emergency_phone: "เบอร์โทรผู้ติดต่อฉุกเฉิน",
                form_signature: "ลายเซ็น",
                form_clear_sig: "ล้าง",
                form_submit: "บันทึกข้อมูล",
                msg_success: "บันทึกข้อมูลสำเร็จ!",
                msg_error: "เกิดข้อผิดพลาด:",
                msg_sig_empty: "กรุณาลงลายเซ็น"
            },
            en: {
                agreement_title: "Terms and Conditions",
                agreement_check: "I accept the terms and conditions",
                continue_button: "Continue",
                form_title: "Registration Form",
                form_fname: "First Name",
                form_lname: "Last Name",
                form_dob: "Date of Birth",
                form_emergency_name: "Emergency Contact Name",
                form_emergency_phone: "Emergency Contact Telephone",
                form_signature: "Signature",
                form_clear_sig: "Clear",
                form_submit: "Submit",
                msg_success: "Data saved successfully!",
                msg_error: "An error occurred:",
                msg_sig_empty: "Please provide a signature."
            }
        };

        // DOM Elements
        const agreeCheckbox = document.getElementById('agree-checkbox');
        const continueBtn = document.getElementById('continue-btn');
        const form = document.getElementById('registration-form');
        const submitBtn = document.getElementById('submit-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const canvas = document.getElementById('signature-canvas');
        const clearSigBtn = document.getElementById('clear-signature');

        // ฟังก์ชันแสดงหน้า
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        // ฟังก์ชันเลือกภาษา
        function selectLang(lang) {
            currentLang = lang;
            
            // เปลี่ยนข้อความทั้งหมดในหน้า
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            // สลับข้อความข้อตกลง
            document.querySelectorAll('.lang-text').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelector(`[data-lang-key="agreement_text_${lang}"]`).style.display = 'block';

            // ไปยังหน้าข้อตกลง
            showPage('agreement-page');
        }

        // จัดการ Checkbox
        agreeCheckbox.addEventListener('change', () => {
            if (agreeCheckbox.checked) {
                continueBtn.disabled = false;
                continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                continueBtn.classList.add('hover:bg-blue-700');
            } else {
                continueBtn.disabled = true;
                continueBtn.classList.add('opacity-50', 'cursor-not-allowed');
                continueBtn.classList.remove('hover:bg-blue-700');
            }
        });

        // ----- จัดการ Signature Pad -----
        function initializeSignaturePad() {
            // ปรับขนาด canvas ให้พอดีกับ container
            function resizeCanvas() {
                const ratio =  Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
            }
            
            // รอให้หน้า form-page แสดงผลก่อน (เนื่องจาก canvas ถูกซ่อน)
            // เราจะใช้ IntersectionObserver เพื่อตรวจจับเมื่อ canvas ปรากฏ
            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) {
                    if (!signaturePad) { // สร้างแค่ครั้งเดียว
                        resizeCanvas();
                        signaturePad = new SignaturePad(canvas, {
                            backgroundColor: 'rgb(255, 255, 255)'
                        });
                        window.addEventListener('resize', resizeCanvas); // ปรับขนาดเมื่อหน้าจอเปลี่ยน
                    }
                    signaturePad.clear();
                }
            }, { threshold: 0.1 });

            observer.observe(canvas);
        }
        
        // ปุ่มล้างลายเซ็น
        clearSigBtn.addEventListener('click', () => {
            if (signaturePad) {
                signaturePad.clear();
            }
        });

        // เรียกใช้ตอนเริ่มต้น
        initializeSignaturePad();
        
        // ----- จัดการการ Submit Form -----
        form.addEventListener('submit', async (e) => {
            e.preventDefault(); // ป้องกันการโหลดหน้าใหม่

            // ตรวจสอบว่า URL ถูกตั้งค่าหรือยัง
            if (GOOGLE_APPS_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                showError('Please set the GOOGLE_APPS_SCRIPT_URL in the script.');
                return;
            }

            // ตรวจสอบลายเซ็น
            if (signaturePad.isEmpty()) {
                showError(translations[currentLang].msg_sig_empty);
                return;
            }

            // แสดง Loading
            setLoading(true);
            hideMessages();

            // รวบรวมข้อมูล
            const formData = new FormData(form);
            const formValues = Object.fromEntries(formData.entries());
            
            // ---- สร้างข้อมูลใหม่ตามที่ผู้ใช้ร้องขอ ----
            const submissionDate = new Date();
            const calculatedAge = calculateAge(formValues.dob);
            
            // ตั้งค่าตัวเลือกการจัดรูปแบบวันที่และเวลา (โซนเวลาไทย)
            const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Bangkok' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Asia/Bangkok' };

            const data = {
                "ID": crypto.randomUUID(), // สร้าง ID อัตโนมัติ
                "ชื่อ": formValues.firstName,
                "นามสกุล": formValues.lastName,
                "วันเกิด": formValues.dob,
                "อายุ": calculatedAge, // อายุที่คำนวณได้
                "ชื่อผู้ติดต่อกรณีฉุกเฉิน": formValues.emergencyName,
                "หมายเลขติดต่อกรณีฉุกเฉิน": formValues.emergencyPhone,
                "เวลา": submissionDate.toLocaleTimeString('th-TH', timeOptions), // เวลา (เช่น 15:30:01)
                "ลายเซ็น": signaturePad.toDataURL('image/png'), // ส่งเป็น data URL
                "วันที่": submissionDate.toLocaleDateString('th-TH', dateOptions) // วันที่ (เช่น 25/10/2568)
            };
            // ---- สิ้นสุดการสร้างข้อมูลใหม่ ----

            try {
                // ส่งข้อมูลไปยัง Google Apps Script
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', // ต้องเปิด CORS ใน Apps Script
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (result.status === 'success') {
                    // สำเร็จ
                    showSuccess();
                    form.reset();
                    signaturePad.clear();
                    // กลับไปหน้าเลือกภาษาหลังหน่วงเวลา
                    setTimeout(() => {
                        showPage('lang-page');
                        hideMessages();
                        agreeCheckbox.checked = false; // รีเซ็ต checkbox
                        continueBtn.disabled = true;
                        continueBtn.classList.add('opacity-50', 'cursor-not-allowed');

                    }, 3000);
                } else {
                    // ล้มเหลว (จากฝั่ง Apps Script)
                    showError(result.message || 'Unknown error');
                }

            } catch (error) {
                // ล้มเหลว (Network error)
                showError(error.message);
            } finally {
                // หยุด Loading
                setLoading(false);
            }
        });

        // ----- ฟังก์ชันช่วย (Helpers) -----

        function setLoading(isLoading) {
            if (isLoading) {
                submitBtn.disabled = true;
                loadingSpinner.style.display = 'block';
                submitBtn.querySelector('span').textContent = 'Loading...';
            } else {
                submitBtn.disabled = false;
                loadingSpinner.style.display = 'none';
                submitBtn.querySelector('span').textContent = translations[currentLang].form_submit;
            }
        }

        function showSuccess() {
            successMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
        }

        function hideMessages() {
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
        }

        // ----- ฟังก์ชันใหม่สำหรับคำนวณอายุ -----
        function calculateAge(dobString) {
            if (!dobString) return '';
            try {
                const dob = new Date(dobString);
                const diff_ms = Date.now() - dob.getTime();
                const age_dt = new Date(diff_ms); 
                return Math.abs(age_dt.getUTCFullYear() - 1970);
            } catch (e) {
                console.error('Error calculating age:', e);
                return ''; // คืนค่าว่างหากคำนวณไม่ได้
            }
        }

    </script>
</body>
</html>


